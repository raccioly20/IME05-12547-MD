{
  "hash": "1a060165743dd14a1d4cf249342ef47a",
  "result": {
    "markdown": "---\ntitle: \"Regularização de Modelos\"\nauthor: \"Ricardo Accioly\"\ndate: \"2023-09-14\"\nformat:\n html:\n    code-link: true\n---\n\n\n## Regularização de modelos\n\n## Carregando Bibliotecas\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\nlibrary(tidyverse)\nlibrary(glmnet)\ndata(Boston)\n```\n:::\n\n\n## Carregando os dados\n\nVamos utilizar neste exemplo os dados contidos na biblioteca MASS. A base de dados Boston tem 506 de valores preços medianos de casas na região de Boston com 13 outras variáveis explicativas (potencialmente). Vamos explorar os dados e ajustar modelos com penalização o Ridge e o LASSO e depois vamos comparar com os mínimos quadrados.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(Boston)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     crim zn indus chas   nox    rm  age    dis rad tax ptratio  black lstat\n1 0.00632 18  2.31    0 0.538 6.575 65.2 4.0900   1 296    15.3 396.90  4.98\n2 0.02731  0  7.07    0 0.469 6.421 78.9 4.9671   2 242    17.8 396.90  9.14\n3 0.02729  0  7.07    0 0.469 7.185 61.1 4.9671   2 242    17.8 392.83  4.03\n4 0.03237  0  2.18    0 0.458 6.998 45.8 6.0622   3 222    18.7 394.63  2.94\n5 0.06905  0  2.18    0 0.458 7.147 54.2 6.0622   3 222    18.7 396.90  5.33\n6 0.02985  0  2.18    0 0.458 6.430 58.7 6.0622   3 222    18.7 394.12  5.21\n  medv\n1 24.0\n2 21.6\n3 34.7\n4 33.4\n5 36.2\n6 28.7\n```\n:::\n\n```{.r .cell-code}\nsummary(Boston)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      crim                zn             indus            chas        \n Min.   : 0.00632   Min.   :  0.00   Min.   : 0.46   Min.   :0.00000  \n 1st Qu.: 0.08205   1st Qu.:  0.00   1st Qu.: 5.19   1st Qu.:0.00000  \n Median : 0.25651   Median :  0.00   Median : 9.69   Median :0.00000  \n Mean   : 3.61352   Mean   : 11.36   Mean   :11.14   Mean   :0.06917  \n 3rd Qu.: 3.67708   3rd Qu.: 12.50   3rd Qu.:18.10   3rd Qu.:0.00000  \n Max.   :88.97620   Max.   :100.00   Max.   :27.74   Max.   :1.00000  \n      nox               rm             age              dis        \n Min.   :0.3850   Min.   :3.561   Min.   :  2.90   Min.   : 1.130  \n 1st Qu.:0.4490   1st Qu.:5.886   1st Qu.: 45.02   1st Qu.: 2.100  \n Median :0.5380   Median :6.208   Median : 77.50   Median : 3.207  \n Mean   :0.5547   Mean   :6.285   Mean   : 68.57   Mean   : 3.795  \n 3rd Qu.:0.6240   3rd Qu.:6.623   3rd Qu.: 94.08   3rd Qu.: 5.188  \n Max.   :0.8710   Max.   :8.780   Max.   :100.00   Max.   :12.127  \n      rad              tax           ptratio          black       \n Min.   : 1.000   Min.   :187.0   Min.   :12.60   Min.   :  0.32  \n 1st Qu.: 4.000   1st Qu.:279.0   1st Qu.:17.40   1st Qu.:375.38  \n Median : 5.000   Median :330.0   Median :19.05   Median :391.44  \n Mean   : 9.549   Mean   :408.2   Mean   :18.46   Mean   :356.67  \n 3rd Qu.:24.000   3rd Qu.:666.0   3rd Qu.:20.20   3rd Qu.:396.23  \n Max.   :24.000   Max.   :711.0   Max.   :22.00   Max.   :396.90  \n     lstat            medv      \n Min.   : 1.73   Min.   : 5.00  \n 1st Qu.: 6.95   1st Qu.:17.02  \n Median :11.36   Median :21.20  \n Mean   :12.65   Mean   :22.53  \n 3rd Qu.:16.95   3rd Qu.:25.00  \n Max.   :37.97   Max.   :50.00  \n```\n:::\n:::\n\n\nObservamos acima que todas as variáveis são quantitativas e que não há necessidade de transformações.\n\n## Significado das variáveis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Boston Database\n# \n#1) crim - taxa de criminalidade per capita por cidade.\n# \n#2) zn - proporção de terrenos residenciais para lotes acima de 25,000 sq.ft.\n# \n#3) indus - proporção de negócios não comerciais por acres e por cidade.\n# \n#4) chas - variável dummy do Rio Charles(= 1 se próximo do rio; 0 de outra forma).\n# \n#5) nox - concentração de óxido de nitrogênio (partes por 10 milhões).\n# \n#6) rm - número médio de quartos por habitação\n# \n#7) age - proporção da unidade ocupadas pelos proprietários construídas antes 1940.\n# \n#8) dis - média ponderada das distâncias dos 5 pontos de emprego em Boston.\n# \n#9) rad - indice de acessibilidade das avenidas radiais.\n# \n#10) tax - valor cheio da taxa de propriedade por $10,000.\n# \n#11) ptratio - razão aluno-professor por cidade.\n# \n#12) black - 1000(Bk−0.63)21000(Bk−0.63)2 proporção de negros por cidade.\n# \n#13) lstat - percentual de baixo status da população.\n# \n#14) medv - valor mediano das cas ocupadas pelos proprietário em $1000s. (Var. Resposta)\n```\n:::\n\n\n## Conjunto de treino e de teste\n\nObservar que retiramos a variável **rad**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(caret)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nCarregando pacotes exigidos: lattice\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'caret'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:purrr':\n\n    lift\n```\n:::\n\n```{.r .cell-code}\nset.seed(21)\ny <- Boston$medv\nindice_teste <- createDataPartition(y, times = 1, p = 0.2, list = FALSE)\n\n\nconj_treino <- Boston[-indice_teste, ]\nconj_teste <- Boston[indice_teste, ]\n\nconj_treino <- conj_treino %>% select(-rad)\nconj_teste <- conj_teste %>% select(-rad)\n\nstr(conj_treino)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n'data.frame':\t403 obs. of  13 variables:\n $ crim   : num  0.00632 0.02731 0.02729 0.03237 0.06905 ...\n $ zn     : num  18 0 0 0 0 0 12.5 12.5 12.5 12.5 ...\n $ indus  : num  2.31 7.07 7.07 2.18 2.18 2.18 7.87 7.87 7.87 7.87 ...\n $ chas   : int  0 0 0 0 0 0 0 0 0 0 ...\n $ nox    : num  0.538 0.469 0.469 0.458 0.458 0.458 0.524 0.524 0.524 0.524 ...\n $ rm     : num  6.58 6.42 7.18 7 7.15 ...\n $ age    : num  65.2 78.9 61.1 45.8 54.2 58.7 66.6 96.1 85.9 94.3 ...\n $ dis    : num  4.09 4.97 4.97 6.06 6.06 ...\n $ tax    : num  296 242 242 222 222 222 311 311 311 311 ...\n $ ptratio: num  15.3 17.8 17.8 18.7 18.7 18.7 15.2 15.2 15.2 15.2 ...\n $ black  : num  397 397 393 395 397 ...\n $ lstat  : num  4.98 9.14 4.03 2.94 5.33 ...\n $ medv   : num  24 21.6 34.7 33.4 36.2 28.7 22.9 27.1 18.9 15 ...\n```\n:::\n\n```{.r .cell-code}\nstr(conj_teste)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n'data.frame':\t103 obs. of  13 variables:\n $ crim   : num  0.211 0.63 0.627 1.252 0.852 ...\n $ zn     : num  12.5 0 0 0 0 0 0 75 0 0 ...\n $ indus  : num  7.87 8.14 8.14 8.14 8.14 8.14 8.14 2.95 6.91 6.91 ...\n $ chas   : int  0 0 0 0 0 0 0 0 0 0 ...\n $ nox    : num  0.524 0.538 0.538 0.538 0.538 0.538 0.538 0.428 0.448 0.448 ...\n $ rm     : num  5.63 5.95 5.83 5.57 5.96 ...\n $ age    : num  100 61.8 56.5 98.1 89.2 94.1 96.9 21.8 6.5 95.3 ...\n $ dis    : num  6.08 4.71 4.5 3.8 4.01 ...\n $ tax    : num  311 307 307 307 307 307 307 252 233 233 ...\n $ ptratio: num  15.2 21 21 21 21 21 21 18.3 17.9 17.9 ...\n $ black  : num  387 397 396 377 393 ...\n $ lstat  : num  29.93 8.26 8.47 21.02 13.83 ...\n $ medv   : num  16.5 20.4 19.9 13.6 19.6 12.7 13.5 30.8 24.7 14.4 ...\n```\n:::\n:::\n\n\n## Métodos de Regularização com o caret\n\nUsando o caret para selecionar o melhor modelo\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_control <- trainControl(\n  method = \"repeatedcv\",\n  number = 10,  # validação cruzada com 10 folds\n  repeats = 5,  # 5 repetições\n  savePredictions = \"final\"  # salva os resultados do modelo final\n)\n```\n:::\n\n\n## Cross-Validation no caret\n\nNós podemos usar o k-fold cross validation para identificar o melhor valor de $\\lambda$\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(21)\nmdl_ridge <- train(\n  medv ~ .,\n  data = conj_treino,\n  method = \"glmnet\",\n  metric = \"RMSE\",  \n  preProcess = c(\"center\", \"scale\"),\n  tuneGrid = expand.grid(\n    .alpha = 0,  # regressão ridge\n    .lambda = seq(0, 5, length.out = 101)\n  ),\n  trControl = train_control\n  )\nmdl_ridge\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nglmnet \n\n403 samples\n 12 predictor\n\nPre-processing: centered (12), scaled (12) \nResampling: Cross-Validated (10 fold, repeated 5 times) \nSummary of sample sizes: 363, 362, 364, 362, 363, 363, ... \nResampling results across tuning parameters:\n\n  lambda  RMSE      Rsquared   MAE     \n  0.00    4.637618  0.7506012  3.264499\n  0.05    4.637618  0.7506012  3.264499\n  0.10    4.637618  0.7506012  3.264499\n  0.15    4.637618  0.7506012  3.264499\n  0.20    4.637618  0.7506012  3.264499\n  0.25    4.637618  0.7506012  3.264499\n  0.30    4.637618  0.7506012  3.264499\n  0.35    4.637618  0.7506012  3.264499\n  0.40    4.637618  0.7506012  3.264499\n  0.45    4.637618  0.7506012  3.264499\n  0.50    4.637618  0.7506012  3.264499\n  0.55    4.637618  0.7506012  3.264499\n  0.60    4.637618  0.7506012  3.264499\n  0.65    4.637618  0.7506012  3.264499\n  0.70    4.638946  0.7505734  3.265041\n  0.75    4.640216  0.7505864  3.265350\n  0.80    4.641506  0.7506047  3.265713\n  0.85    4.642949  0.7506107  3.266347\n  0.90    4.644555  0.7506056  3.267143\n  0.95    4.646293  0.7505908  3.268062\n  1.00    4.648169  0.7505660  3.269133\n  1.05    4.650182  0.7505317  3.270338\n  1.10    4.652305  0.7504891  3.271706\n  1.15    4.654534  0.7504397  3.273161\n  1.20    4.656872  0.7503822  3.274721\n  1.25    4.659312  0.7503173  3.276326\n  1.30    4.661864  0.7502445  3.278033\n  1.35    4.664479  0.7501669  3.279822\n  1.40    4.667203  0.7500825  3.281662\n  1.45    4.669988  0.7499929  3.283542\n  1.50    4.672848  0.7498988  3.285483\n  1.55    4.675811  0.7497974  3.287470\n  1.60    4.678812  0.7496924  3.289436\n  1.65    4.681881  0.7495839  3.291397\n  1.70    4.685044  0.7494686  3.293438\n  1.75    4.688235  0.7493504  3.295552\n  1.80    4.691480  0.7492294  3.297766\n  1.85    4.694817  0.7491018  3.300018\n  1.90    4.698183  0.7489717  3.302337\n  1.95    4.701583  0.7488388  3.304735\n  2.00    4.705048  0.7487026  3.307202\n  2.05    4.708583  0.7485609  3.309708\n  2.10    4.712128  0.7484176  3.312242\n  2.15    4.715701  0.7482729  3.314858\n  2.20    4.719341  0.7481242  3.317537\n  2.25    4.723039  0.7479706  3.320286\n  2.30    4.726740  0.7478163  3.323069\n  2.35    4.730460  0.7476607  3.325868\n  2.40    4.734231  0.7475026  3.328720\n  2.45    4.738069  0.7473390  3.331673\n  2.50    4.741908  0.7471747  3.334656\n  2.55    4.745758  0.7470089  3.337643\n  2.60    4.749627  0.7468433  3.340630\n  2.65    4.753554  0.7466733  3.343683\n  2.70    4.757530  0.7464993  3.346808\n  2.75    4.761495  0.7463253  3.349970\n  2.80    4.765469  0.7461500  3.353135\n  2.85    4.769456  0.7459752  3.356357\n  2.90    4.773493  0.7457967  3.359599\n  2.95    4.777582  0.7456139  3.362885\n  3.00    4.781661  0.7454309  3.366147\n  3.05    4.785741  0.7452474  3.369400\n  3.10    4.789816  0.7450647  3.372650\n  3.15    4.793920  0.7448809  3.375876\n  3.20    4.798079  0.7446923  3.379129\n  3.25    4.802268  0.7445010  3.382396\n  3.30    4.806435  0.7443105  3.385656\n  3.35    4.810603  0.7441195  3.388912\n  3.40    4.814760  0.7439297  3.392136\n  3.45    4.818939  0.7437394  3.395334\n  3.50    4.823164  0.7435449  3.398543\n  3.55    4.827425  0.7433471  3.401784\n  3.60    4.831675  0.7431492  3.405011\n  3.65    4.835911  0.7429519  3.408201\n  3.70    4.840140  0.7427547  3.411373\n  3.75    4.844365  0.7425585  3.414501\n  3.80    4.848618  0.7423607  3.417625\n  3.85    4.852915  0.7421585  3.420776\n  3.90    4.857239  0.7419539  3.423951\n  3.95    4.861544  0.7417497  3.427149\n  4.00    4.865834  0.7415465  3.430337\n  4.05    4.870115  0.7413429  3.433516\n  4.10    4.874382  0.7411408  3.436681\n  4.15    4.878667  0.7409383  3.439865\n  4.20    4.882985  0.7407323  3.443068\n  4.25    4.887338  0.7405230  3.446274\n  4.30    4.891696  0.7403127  3.449481\n  4.35    4.896028  0.7401037  3.452682\n  4.40    4.900348  0.7398952  3.455865\n  4.45    4.904652  0.7396873  3.459021\n  4.50    4.908943  0.7394808  3.462155\n  4.55    4.913247  0.7392740  3.465272\n  4.60    4.917579  0.7390643  3.468414\n  4.65    4.921944  0.7388514  3.471580\n  4.70    4.926322  0.7386368  3.474742\n  4.75    4.930675  0.7384232  3.477870\n  4.80    4.935006  0.7382112  3.480974\n  4.85    4.939333  0.7379987  3.484092\n  4.90    4.943630  0.7377883  3.487175\n  4.95    4.947921  0.7375787  3.490254\n  5.00    4.952227  0.7373683  3.493337\n\nTuning parameter 'alpha' was held constant at a value of 0\nRMSE was used to select the optimal model using the smallest value.\nThe final values used for the model were alpha = 0 and lambda = 0.65.\n```\n:::\n\n```{.r .cell-code}\nggplot(mdl_ridge) +\n  labs(title = \"Regressão Ridge Ajuste do Parametro\", x = \"lambda\")\n```\n\n::: {.cell-output-display}\n![](Aula07.4A_files/figure-html/r4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(varImp(mdl_ridge))\n```\n\n::: {.cell-output-display}\n![](Aula07.4A_files/figure-html/r4-2.png){width=672}\n:::\n:::\n\n\n## Avaliando o modelo com o conjunto de teste\n\nAqui usamos a reamostragem com os dados de teste para avaliar o modelo\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Metricas de desempenho\npr_ridge <- postResample(pred = predict(mdl_ridge, newdata = conj_teste), obs = conj_teste$medv)\npr_ridge\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     RMSE  Rsquared       MAE \n5.9785023 0.5777472 3.7537707 \n```\n:::\n:::\n\n\n\n## Modelo Final Ridge\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(21)\nmdl_final_ridge <- train(\n  medv ~ .,\n  data = conj_treino,\n  method = \"glmnet\",\n  metric = \"RMSE\",\n  preProcess = c(\"center\", \"scale\"),\n  tuneGrid = data.frame(\n    .alpha = mdl_ridge$bestTune$alpha,  # hiperparametro otimizado\n    .lambda = mdl_ridge$bestTune$lambda),  # hiperparametro otimizado\n  trControl = train_control\n  )\nmdl_final_ridge\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nglmnet \n\n403 samples\n 12 predictor\n\nPre-processing: centered (12), scaled (12) \nResampling: Cross-Validated (10 fold, repeated 5 times) \nSummary of sample sizes: 363, 362, 364, 362, 363, 363, ... \nResampling results:\n\n  RMSE      Rsquared   MAE     \n  4.637618  0.7506012  3.264499\n\nTuning parameter 'alpha' was held constant at a value of 0\nTuning\n parameter 'lambda' was held constant at a value of 0.65\n```\n:::\n\n```{.r .cell-code}\nsqrt(mean((conj_teste$medv - predict(mdl_final_ridge, newdata = conj_teste)) ^ 2))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 5.978502\n```\n:::\n:::\n\n\n\n\n## LASSO\n\n## Validação Cruzada no LASSO\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(21)\nmdl_lasso <- train(\n  medv ~ .,\n  data = conj_treino,\n  method = \"glmnet\",\n  metric = \"RMSE\",\n  preProcess = c(\"center\", \"scale\"),\n  tuneGrid = expand.grid(\n    .alpha = 1,  # regressão lasso\n    .lambda = seq(0, 5, length.out = 101)\n  ),\n  trControl = train_control\n  )\nmdl_lasso$bestTune\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  alpha lambda\n2     1   0.05\n```\n:::\n\n```{.r .cell-code}\nggplot(mdl_lasso) +\n  labs(title = \"Regressão Lasso - Ajuste de parametro\", x = \"lambda\")\n```\n\n::: {.cell-output-display}\n![](Aula07.4A_files/figure-html/Lasso2-1.png){width=672}\n:::\n:::\n\n\n## Avaliando com conjunto de teste\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Metricas de desempenho\npr_lasso <- postResample(pred = predict(mdl_lasso, newdata = conj_teste), obs = conj_teste$medv)\npr_lasso\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     RMSE  Rsquared       MAE \n6.0255455 0.5735621 3.7869316 \n```\n:::\n:::\n\n\n## Modelo Final Lasso\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(21)\nmdl_final_lasso <- train(\n  medv ~ .,\n  data = conj_treino,\n  method = \"glmnet\",\n  metric = \"RMSE\",\n  preProcess = c(\"center\", \"scale\"),\n  tuneGrid = data.frame(\n    .alpha = mdl_lasso$bestTune$alpha,  # hiperparametro otimizado\n    .lambda = mdl_lasso$bestTune$lambda),  # hiperparametro otimizado\n  trControl = train_control\n  )\nmdl_final_lasso\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nglmnet \n\n403 samples\n 12 predictor\n\nPre-processing: centered (12), scaled (12) \nResampling: Cross-Validated (10 fold, repeated 5 times) \nSummary of sample sizes: 363, 362, 364, 362, 363, 363, ... \nResampling results:\n\n  RMSE      Rsquared   MAE     \n  4.637888  0.7498274  3.268108\n\nTuning parameter 'alpha' was held constant at a value of 1\nTuning\n parameter 'lambda' was held constant at a value of 0.05\n```\n:::\n\n```{.r .cell-code}\nsqrt(mean((conj_teste$medv - predict(mdl_final_lasso, newdata = conj_teste)) ^ 2))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 6.025546\n```\n:::\n:::\n",
    "supporting": [
      "Aula07.4A_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}