{
  "hash": "d4c1213a6c26d5fd1ff092885e0c3058",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Regressão Logística\"\nauthor: \"Ricardo Accioly\"\ndate: \"2025-10-28\"\nformat:\n html:\n    code-link: true\n    fig-height: 8\n    fig-width: 12\n    fig-align: center\nknitr:\n  opts_chunk: \n    out.width: 90%\n    comment: \"#>\"\nexecute: \n  echo: true\n  warning: false\n  message: false\n  freeze: auto\n---\n\n## Carregando Bibliotecas\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(caret)\nlibrary(patchwork)\nlibrary(pROC)\nlibrary(ISLR)\ndata(Default)\nsummary(Default)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>  default    student       balance           income     \n#>  No :9667   No :7056   Min.   :   0.0   Min.   :  772  \n#>  Yes: 333   Yes:2944   1st Qu.: 481.7   1st Qu.:21340  \n#>                        Median : 823.6   Median :34553  \n#>                        Mean   : 835.4   Mean   :33517  \n#>                        3rd Qu.:1166.3   3rd Qu.:43808  \n#>                        Max.   :2654.3   Max.   :73554\n```\n\n\n:::\n\n```{.r .cell-code}\nstr(Default)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> 'data.frame':\t10000 obs. of  4 variables:\n#>  $ default: Factor w/ 2 levels \"No\",\"Yes\": 1 1 1 1 1 1 1 1 1 1 ...\n#>  $ student: Factor w/ 2 levels \"No\",\"Yes\": 1 2 1 1 1 2 1 2 1 1 ...\n#>  $ balance: num  730 817 1074 529 786 ...\n#>  $ income : num  44362 12106 31767 35704 38463 ...\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(Default)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>   default student   balance    income\n#> 1      No      No  729.5265 44361.625\n#> 2      No     Yes  817.1804 12106.135\n#> 3      No      No 1073.5492 31767.139\n#> 4      No      No  529.2506 35704.494\n#> 5      No      No  785.6559 38463.496\n#> 6      No     Yes  919.5885  7491.559\n```\n\n\n:::\n:::\n\n\n## Manipulando os dados\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncredito <- tibble(Default)\nsummary(credito)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>  default    student       balance           income     \n#>  No :9667   No :7056   Min.   :   0.0   Min.   :  772  \n#>  Yes: 333   Yes:2944   1st Qu.: 481.7   1st Qu.:21340  \n#>                        Median : 823.6   Median :34553  \n#>                        Mean   : 835.4   Mean   :33517  \n#>                        3rd Qu.:1166.3   3rd Qu.:43808  \n#>                        Max.   :2654.3   Max.   :73554\n```\n\n\n:::\n\n```{.r .cell-code}\n# renomeando colunas\ncredito <- credito %>% \n                rename( inadimplente = default, estudante = student, balanco = balance,\n                receita = income)\ncredito <- credito %>% mutate( inadimplente =  case_when(\n                           inadimplente == \"No\"  ~ \"Nao\",\n                           inadimplente == \"Yes\" ~ \"Sim\"\n                          )) %>% mutate(inadimplente = factor(inadimplente))\ncredito <- credito %>% mutate( estudante =  case_when(\n                           estudante == \"No\"  ~ 0,\n                           estudante == \"Yes\" ~ 1\n                          )) \n\nstr(credito)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> tibble [10,000 × 4] (S3: tbl_df/tbl/data.frame)\n#>  $ inadimplente: Factor w/ 2 levels \"Nao\",\"Sim\": 1 1 1 1 1 1 1 1 1 1 ...\n#>  $ estudante   : num [1:10000] 0 1 0 0 0 1 0 1 0 0 ...\n#>  $ balanco     : num [1:10000] 730 817 1074 529 786 ...\n#>  $ receita     : num [1:10000] 44362 12106 31767 35704 38463 ...\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(credito)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>  inadimplente   estudante         balanco          receita     \n#>  Nao:9667     Min.   :0.0000   Min.   :   0.0   Min.   :  772  \n#>  Sim: 333     1st Qu.:0.0000   1st Qu.: 481.7   1st Qu.:21340  \n#>               Median :0.0000   Median : 823.6   Median :34553  \n#>               Mean   :0.2944   Mean   : 835.4   Mean   :33517  \n#>               3rd Qu.:1.0000   3rd Qu.:1166.3   3rd Qu.:43808  \n#>               Max.   :1.0000   Max.   :2654.3   Max.   :73554\n```\n\n\n:::\n:::\n\n\n## Matriz de dispersão\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfeaturePlot(x = credito[, c(\"balanco\", \"receita\", \"estudante\")], \n            y = credito$inadimplente,\n            plot = \"density\", \n            scales = list(x = list(relation = \"free\"), \n                          y = list(relation = \"free\")), \n            adjust = 1.5, \n            pch = \"|\", \n            layout = c(2, 1), \n            auto.key = list(columns = 2))\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/unnamed-chunk-1-1.png){width=90%}\n:::\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/unnamed-chunk-1-2.png){width=90%}\n:::\n:::\n\n\n## Avaliando o comportamento das variáveis em função do status (inadimplente / estudante)\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot(credito, aes(x=inadimplente, y=balanco, color=inadimplente)) +\n  geom_boxplot()\np2 <- ggplot(credito, aes(x=inadimplente, y=receita, color=inadimplente)) +\n  geom_boxplot()\np3 <- ggplot(credito, aes(x=as.factor(estudante), y=balanco, color=as.factor(estudante))) +\n  geom_boxplot()\np4 <- ggplot(credito, aes(x=as.factor(estudante), y=receita, color=as.factor(estudante))) +\n  geom_boxplot()\n(p1 + p2) / (p3 + p4)\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/box-plot-1.png){width=90%}\n:::\n:::\n\n\n## Balanço vs Receita\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = credito, aes(x=balanco,  y = receita, col = inadimplente)) +\n  geom_point() \n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/dispersao-1.png){width=90%}\n:::\n:::\n\n\n## Avaliando comportamento\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# proporção de inadimplentes\ncredito %>% select(inadimplente, balanco) %>% summarize(prop = mean(inadimplente == \"Sim\")) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 1 × 1\n#>     prop\n#>    <dbl>\n#> 1 0.0333\n```\n\n\n:::\n\n```{.r .cell-code}\n# media do balanço dos inadimplentes \ncredito %>% filter(inadimplente == \"Sim\") %>% summarize(valor= mean(balanco))   \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 1 × 1\n#>   valor\n#>   <dbl>\n#> 1 1748.\n```\n\n\n:::\n\n```{.r .cell-code}\nquantis <- quantile(credito$balanco, probs = c(.1,.25, .50, .75, .9, .95, 0.97, 0.99))\nquantis\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>       10%       25%       50%       75%       90%       95%       97%       99% \n#>  180.5753  481.7311  823.6370 1166.3084 1471.6253 1665.9626 1793.2910 2008.4709\n```\n\n\n:::\n\n```{.r .cell-code}\ncredito %>% \n            mutate(grupo_balanco = case_when(\n               balanco<=quantis[1] ~ quantis[1],\n               balanco>quantis[1] & balanco<=quantis[2] ~ quantis[2],\n               balanco>quantis[2] & balanco<=quantis[3]  ~ quantis[3],\n               balanco>quantis[3] & balanco<=quantis[4]  ~ quantis[4],\n               balanco>quantis[4] & balanco<=quantis[5]  ~ quantis[5],\n               balanco>quantis[5] & balanco<=quantis[6]  ~ quantis[6],\n               balanco>quantis[6] & balanco<=quantis[7]  ~ quantis[7],\n               balanco>quantis[7] ~ quantis[8])) %>%\n           group_by(grupo_balanco) %>%\n           summarize(prop = mean(inadimplente == \"Sim\")) %>%\n           ggplot(aes(grupo_balanco, prop)) +\n           geom_point() +\n           geom_line()\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/1avaliacao-1.png){width=90%}\n:::\n:::\n\n\n## Treino e Teste\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(2025)\ny <- credito$inadimplente\ncredito_split <- createDataPartition(y, times = 1, p = 0.10, list = FALSE)\n\nconj_treino <- credito[-credito_split,]\nconj_teste <- credito[credito_split,]\n                           \nsummary(conj_treino)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>  inadimplente   estudante         balanco          receita     \n#>  Nao:8700     Min.   :0.0000   Min.   :   0.0   Min.   :  772  \n#>  Sim: 299     1st Qu.:0.0000   1st Qu.: 483.6   1st Qu.:21343  \n#>               Median :0.0000   Median : 821.3   Median :34576  \n#>               Mean   :0.2946   Mean   : 836.3   Mean   :33556  \n#>               3rd Qu.:1.0000   3rd Qu.:1167.1   3rd Qu.:43854  \n#>               Max.   :1.0000   Max.   :2654.3   Max.   :73554\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(conj_teste)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>  inadimplente   estudante         balanco          receita     \n#>  Nao:967      Min.   :0.0000   Min.   :   0.0   Min.   : 5386  \n#>  Sim: 34      1st Qu.:0.0000   1st Qu.: 453.6   1st Qu.:21319  \n#>               Median :0.0000   Median : 839.9   Median :34086  \n#>               Mean   :0.2927   Mean   : 827.4   Mean   :33170  \n#>               3rd Qu.:1.0000   3rd Qu.:1156.3   3rd Qu.:42856  \n#>               Max.   :1.0000   Max.   :2221.0   Max.   :70701\n```\n\n\n:::\n:::\n\n\n## 1a Regressão logística: só balanço\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod1 <- glm(inadimplente ~ balanco,data=conj_treino,family=binomial)\nsummary(mod1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = inadimplente ~ balanco, family = binomial, data = conj_treino)\n#> \n#> Coefficients:\n#>               Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept) -1.081e+01  3.900e-01  -27.72   <2e-16 ***\n#> balanco      5.594e-03  2.375e-04   23.55   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 2623.8  on 8998  degrees of freedom\n#> Residual deviance: 1415.7  on 8997  degrees of freedom\n#> AIC: 1419.7\n#> \n#> Number of Fisher Scoring iterations: 8\n```\n\n\n:::\n\n```{.r .cell-code}\ncoef(mod1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>   (Intercept)       balanco \n#> -10.810958936   0.005594178\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(mod1)$coef\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>                  Estimate   Std. Error   z value      Pr(>|z|)\n#> (Intercept) -10.810958936 0.3900304107 -27.71825 4.208540e-169\n#> balanco       0.005594178 0.0002374991  23.55452 1.128292e-122\n```\n\n\n:::\n:::\n\n\n## Avaliando o modelo\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_chapeu <- predict(mod1, newdata = conj_teste, type = \"response\")\ny_chapeu <- ifelse(p_chapeu > 0.5, \"Sim\", \"Nao\") %>% factor(levels = levels(conj_teste$inadimplente))\nconfusionMatrix(y_chapeu, conj_teste$inadimplente, positive=\"Sim\") \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Confusion Matrix and Statistics\n#> \n#>           Reference\n#> Prediction Nao Sim\n#>        Nao 958  25\n#>        Sim   9   9\n#>                                           \n#>                Accuracy : 0.966           \n#>                  95% CI : (0.9529, 0.9764)\n#>     No Information Rate : 0.966           \n#>     P-Value [Acc > NIR] : 0.5454          \n#>                                           \n#>                   Kappa : 0.3304          \n#>                                           \n#>  Mcnemar's Test P-Value : 0.0101          \n#>                                           \n#>             Sensitivity : 0.264706        \n#>             Specificity : 0.990693        \n#>          Pos Pred Value : 0.500000        \n#>          Neg Pred Value : 0.974568        \n#>              Prevalence : 0.033966        \n#>          Detection Rate : 0.008991        \n#>    Detection Prevalence : 0.017982        \n#>       Balanced Accuracy : 0.627699        \n#>                                           \n#>        'Positive' Class : Sim             \n#> \n```\n\n\n:::\n:::\n\n\n## Veja as probabilidade de inadimplencia para balanços de 1000, 2000 e 3000\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredict(mod1, newdata = data.frame(balanco = c(1000,2000,3000)), type=\"response\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>           1           2           3 \n#> 0.005395494 0.593245119 0.997456265\n```\n\n\n:::\n:::\n\n\n## Curva S\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Mostrar a curva S com o resultado da regressão logística\n# Salvar o gráfico em um arquivo .png\npng(\"regressao_logistica.png\", width = 800, height = 600)\ninadimpl <- as.numeric(conj_treino$inadimplente) - 1\nplot(inadimpl ~ balanco, data = conj_treino, col = \"darkorange\", pch = \"|\", ylim = c(0, 1), main = \"Regressão Logistica - Classificacão\")\nabline(h = 0, lty = 3)\nabline(h = 1, lty = 3)\nabline(h = 0.5, lty = 2)\ncurve(predict(mod1, data.frame(balanco = x), type = \"response\"), add = TRUE, lwd = 3, col = \"dodgerblue\")\nabline(v = -coef(mod1)[1] / coef(mod1)[2], lwd = 2)\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> png \n#>   2\n```\n\n\n:::\n\n```{.r .cell-code}\nknitr::include_graphics(\"regressao_logistica.png\")\n```\n\n::: {.cell-output-display}\n![](regressao_logistica.png){width=90%}\n:::\n:::\n\n\n## Valor de balanço com probabilidade de 50%\n\n\\-$\\beta_0$/$\\beta_1$\n\n\n::: {.cell}\n\n```{.r .cell-code}\n-coef(mod1)[1] / coef(mod1)[2]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> (Intercept) \n#>    1932.538\n```\n\n\n:::\n:::\n\n\n## 2a Regressão logística: todas as variáveis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod2 <- glm(inadimplente ~ balanco + receita + estudante,data=conj_treino,family=binomial)\nsummary(mod2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = inadimplente ~ balanco + receita + estudante, family = binomial, \n#>     data = conj_treino)\n#> \n#> Coefficients:\n#>               Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept) -1.100e+01  5.277e-01 -20.850   <2e-16 ***\n#> balanco      5.810e-03  2.488e-04  23.356   <2e-16 ***\n#> receita      2.751e-06  8.799e-06   0.313   0.7546    \n#> estudante   -5.942e-01  2.516e-01  -2.362   0.0182 *  \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 2623.8  on 8998  degrees of freedom\n#> Residual deviance: 1396.8  on 8995  degrees of freedom\n#> AIC: 1404.8\n#> \n#> Number of Fisher Scoring iterations: 8\n```\n\n\n:::\n\n```{.r .cell-code}\ncoef(mod2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>   (Intercept)       balanco       receita     estudante \n#> -1.100205e+01  5.810150e-03  2.750839e-06 -5.942048e-01\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(mod2)$coef\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>                  Estimate   Std. Error     z value      Pr(>|z|)\n#> (Intercept) -1.100205e+01 5.276811e-01 -20.8498149  1.530134e-96\n#> balanco      5.810150e-03 2.487659e-04  23.3558946 1.200621e-120\n#> receita      2.750839e-06 8.798705e-06   0.3126414  7.545531e-01\n#> estudante   -5.942048e-01 2.515801e-01  -2.3618911  1.818198e-02\n```\n\n\n:::\n:::\n\n\n**É possível se ver que receita não é significativa**\n\n## 3a Regressão Logística (sem receita)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod3 <- glm(inadimplente ~ balanco + estudante,data=conj_treino,family=binomial)\nsummary(mod3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = inadimplente ~ balanco + estudante, family = binomial, \n#>     data = conj_treino)\n#> \n#> Coefficients:\n#>               Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept) -1.089e+01  3.974e-01 -27.416  < 2e-16 ***\n#> balanco      5.812e-03  2.487e-04  23.368  < 2e-16 ***\n#> estudante   -6.561e-01  1.550e-01  -4.234  2.3e-05 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 2623.8  on 8998  degrees of freedom\n#> Residual deviance: 1396.9  on 8996  degrees of freedom\n#> AIC: 1402.9\n#> \n#> Number of Fisher Scoring iterations: 8\n```\n\n\n:::\n\n```{.r .cell-code}\ncoef(mod3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>   (Intercept)       balanco     estudante \n#> -10.894208021   0.005811976  -0.656054023\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(mod3)$coef\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>                  Estimate   Std. Error   z value      Pr(>|z|)\n#> (Intercept) -10.894208021 0.3973729389 -27.41558 1.788553e-165\n#> balanco       0.005811976 0.0002487146  23.36806 9.031818e-121\n#> estudante    -0.656054023 0.1549533866  -4.23388  2.296937e-05\n```\n\n\n:::\n:::\n\n\n## Comparando os modelos\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(mod2,mod3,test='LR')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Analysis of Deviance Table\n#> \n#> Model 1: inadimplente ~ balanco + receita + estudante\n#> Model 2: inadimplente ~ balanco + estudante\n#>   Resid. Df Resid. Dev Df  Deviance Pr(>Chi)\n#> 1      8995     1396.8                      \n#> 2      8996     1396.9 -1 -0.097739   0.7546\n```\n\n\n:::\n:::\n\n\n## StepAIC\n\nAo invé de usarmos a estatística de Wald para selecionar as variáveis significativas, podemos usar o AIC (**equivalente ao Cp**) como usamos na regressão múltipla para selecionar as variáveis explicativas.\n\nA função **stepAIC** tem um parametro k que define se vamos usar o AIC ou o BIC para fazer a seleção. Quando k=2 temos o AIC e quando k=log(n) temos o BIC.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\nmod3a <- stepAIC(mod2, k=2, trace=FALSE)\nsummary(mod3a)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = inadimplente ~ balanco + estudante, family = binomial, \n#>     data = conj_treino)\n#> \n#> Coefficients:\n#>               Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept) -1.089e+01  3.974e-01 -27.416  < 2e-16 ***\n#> balanco      5.812e-03  2.487e-04  23.368  < 2e-16 ***\n#> estudante   -6.561e-01  1.550e-01  -4.234  2.3e-05 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 2623.8  on 8998  degrees of freedom\n#> Residual deviance: 1396.9  on 8996  degrees of freedom\n#> AIC: 1402.9\n#> \n#> Number of Fisher Scoring iterations: 8\n```\n\n\n:::\n\n```{.r .cell-code}\n(k <- log(nrow(conj_treino)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 9.104869\n```\n\n\n:::\n\n```{.r .cell-code}\nmod3b <- stepAIC(mod2, k=k, trace=FALSE)\nsummary(mod3b)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = inadimplente ~ balanco + estudante, family = binomial, \n#>     data = conj_treino)\n#> \n#> Coefficients:\n#>               Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept) -1.089e+01  3.974e-01 -27.416  < 2e-16 ***\n#> balanco      5.812e-03  2.487e-04  23.368  < 2e-16 ***\n#> estudante   -6.561e-01  1.550e-01  -4.234  2.3e-05 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 2623.8  on 8998  degrees of freedom\n#> Residual deviance: 1396.9  on 8996  degrees of freedom\n#> AIC: 1402.9\n#> \n#> Number of Fisher Scoring iterations: 8\n```\n\n\n:::\n:::\n\n\n## Avaliando o modelo novamente\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_chapeu <- predict(mod3, newdata = conj_teste, type = \"response\")\ny_chapeu <- ifelse(p_chapeu > 0.5, \"Sim\", \"Nao\") %>% factor(levels = levels(conj_teste$inadimplente))\nconfusionMatrix(y_chapeu, conj_teste$inadimplente, positive=\"Sim\") \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Confusion Matrix and Statistics\n#> \n#>           Reference\n#> Prediction Nao Sim\n#>        Nao 960  24\n#>        Sim   7  10\n#>                                           \n#>                Accuracy : 0.969           \n#>                  95% CI : (0.9563, 0.9789)\n#>     No Information Rate : 0.966           \n#>     P-Value [Acc > NIR] : 0.339451        \n#>                                           \n#>                   Kappa : 0.3781          \n#>                                           \n#>  Mcnemar's Test P-Value : 0.004057        \n#>                                           \n#>             Sensitivity : 0.29412         \n#>             Specificity : 0.99276         \n#>          Pos Pred Value : 0.58824         \n#>          Neg Pred Value : 0.97561         \n#>              Prevalence : 0.03397         \n#>          Detection Rate : 0.00999         \n#>    Detection Prevalence : 0.01698         \n#>       Balanced Accuracy : 0.64344         \n#>                                           \n#>        'Positive' Class : Sim             \n#> \n```\n\n\n:::\n:::\n\n\n## Mudando a probabilidade (limite) para aumentar a sensibilidade\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_chapeu <- predict(mod3, newdata = conj_teste, type = \"response\")\ny_chapeu <- ifelse(p_chapeu > 0.1, \"Sim\", \"Nao\") %>% \n             factor(levels = levels(conj_teste$inadimplente))\nconfusionMatrix(y_chapeu, conj_teste$inadimplente, positive=\"Sim\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Confusion Matrix and Statistics\n#> \n#>           Reference\n#> Prediction Nao Sim\n#>        Nao 912  11\n#>        Sim  55  23\n#>                                           \n#>                Accuracy : 0.9341          \n#>                  95% CI : (0.9169, 0.9486)\n#>     No Information Rate : 0.966           \n#>     P-Value [Acc > NIR] : 1               \n#>                                           \n#>                   Kappa : 0.3815          \n#>                                           \n#>  Mcnemar's Test P-Value : 1.204e-07       \n#>                                           \n#>             Sensitivity : 0.67647         \n#>             Specificity : 0.94312         \n#>          Pos Pred Value : 0.29487         \n#>          Neg Pred Value : 0.98808         \n#>              Prevalence : 0.03397         \n#>          Detection Rate : 0.02298         \n#>    Detection Prevalence : 0.07792         \n#>       Balanced Accuracy : 0.80980         \n#>                                           \n#>        'Positive' Class : Sim             \n#> \n```\n\n\n:::\n:::\n\n\n## Curva ROC modelo só com balanço\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_chapeu_log <- predict(mod1, newdata = conj_teste, type = \"response\")\nhead(p_chapeu_log)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>            1            2            3            4            5            6 \n#> 0.0104785745 0.0002668725 0.0029780343 0.0042745671 0.0073908814 0.0005687871\n```\n\n\n:::\n\n```{.r .cell-code}\nroc_log <- roc(conj_teste$inadimplente ~ p_chapeu_log, print.auc=FALSE)\n\n# Visualização com ggroc\nggroc(roc_log) +\n  ggplot2::labs(title = \"ROC - Regressão Logística\", x = \"1 - Especificidade\", y = \"Sensibilidade\") +\n  ggplot2::theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/ROC-1.png){width=90%}\n:::\n\n```{.r .cell-code}\n# Area debaixo da curva\nas.numeric(roc_log$auc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.9291015\n```\n\n\n:::\n:::\n\n\n## Curva ROC 2: Modelo com balanço + estudante\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_chapeu_log <- predict(mod3, newdata = conj_teste, type = \"response\")\nhead(p_chapeu_log)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>            1            2            3            4            5            6 \n#> 0.0064107246 0.0002715269 0.0017294056 0.0048430770 0.0085502222 0.0005960041\n```\n\n\n:::\n\n```{.r .cell-code}\nroc_log2 <- roc(conj_teste$inadimplente ~ p_chapeu_log, print.auc=FALSE)\n\n# Visualização com ggroc\nggroc(roc_log2) +\n  ggplot2::labs(title = \"ROC - Regressão Logística\", x = \"1 - Especificidade\", y = \"Sensibilidade\") +\n  ggplot2::theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/ROC2-1.png){width=90%}\n:::\n:::\n\n\n## AUC\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Area debaixo da curva\nas.numeric(roc_log2$auc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.9325385\n```\n\n\n:::\n:::\n\n\n## Melhor limite\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm_limite <- coords(roc_log2, \"best\", ret = \"threshold\")$threshold\nm_limite\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.03721192\n```\n\n\n:::\n\n```{.r .cell-code}\np_chapeu <- predict(mod3, newdata = conj_teste, type = \"response\")\ny_chapeu <- ifelse(p_chapeu > m_limite, \"Sim\", \"Nao\") %>% \n             factor(levels = levels(conj_teste$inadimplente))\nconfusionMatrix(y_chapeu, conj_teste$inadimplente, positive=\"Sim\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Confusion Matrix and Statistics\n#> \n#>           Reference\n#> Prediction Nao Sim\n#>        Nao 857   5\n#>        Sim 110  29\n#>                                           \n#>                Accuracy : 0.8851          \n#>                  95% CI : (0.8637, 0.9042)\n#>     No Information Rate : 0.966           \n#>     P-Value [Acc > NIR] : 1               \n#>                                           \n#>                   Kappa : 0.2969          \n#>                                           \n#>  Mcnemar's Test P-Value : <2e-16          \n#>                                           \n#>             Sensitivity : 0.85294         \n#>             Specificity : 0.88625         \n#>          Pos Pred Value : 0.20863         \n#>          Neg Pred Value : 0.99420         \n#>              Prevalence : 0.03397         \n#>          Detection Rate : 0.02897         \n#>    Detection Prevalence : 0.13886         \n#>       Balanced Accuracy : 0.86959         \n#>                                           \n#>        'Positive' Class : Sim             \n#> \n```\n\n\n:::\n:::\n\n\n## Duas ROCs juntas\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualização com ggroc\nggroc(list(reglog1= roc_log, reglog2= roc_log2)) +\n  ggplot2::labs(title = \"ROC - Regressão Logística\", x = \"1 - Especificidade\", y = \"Sensibilidade\") +\n  ggplot2::theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/ROCs-1.png){width=90%}\n:::\n\n```{.r .cell-code}\n# Area debaixo da curva\nas.numeric(roc_log$auc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.9291015\n```\n\n\n:::\n\n```{.r .cell-code}\n# Area debaixo da curva\nas.numeric(roc_log2$auc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.9325385\n```\n\n\n:::\n:::\n\n\n## Curva ROC 3 com o KNN\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Ajustando KNN \nconj_treino[,3:4] <- scale(conj_treino[,3:4]) # scale normaliza\nconj_teste[,3:4] <- scale(conj_teste[, 3:4])\nset.seed(2025)\ntreina_knn <- knn3(inadimplente ~ balanco + receita + estudante, data = conj_treino, k = 20)\n# treina_knn\nprev_knn <- predict(treina_knn, conj_teste,type = \"prob\")\n\n## ROC\nroc_log2 <- roc(conj_teste$inadimplente ~ p_chapeu_log, print.auc=FALSE) \nroc_knn1 <- roc(conj_teste$inadimplente ~ prev_knn[,2], print.auc=FALSE)\n\n# Visualização com ggroc\nggroc(list(KNN= roc_knn1, RegLog= roc_log2)) +\n  ggplot2::labs(title = \"ROC - KNN vs Regressão Logística\", x = \"1 - Especificidade\", y = \"Sensibilidade\") +\n  ggplot2::theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/ROC3-1.png){width=90%}\n:::\n\n```{.r .cell-code}\n# Area abaixo da curva\n# Regressão Logística\nas.numeric(roc_log2$auc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.9325385\n```\n\n\n:::\n\n```{.r .cell-code}\n## KNN\nas.numeric(roc_knn1$auc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.9041304\n```\n\n\n:::\n:::\n\n\n## Reprodutibilidade\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> R version 4.5.1 (2025-06-13 ucrt)\n#> Platform: x86_64-w64-mingw32/x64\n#> Running under: Windows 11 x64 (build 26200)\n#> \n#> Matrix products: default\n#>   LAPACK version 3.12.1\n#> \n#> locale:\n#> [1] LC_COLLATE=Portuguese_Brazil.utf8  LC_CTYPE=Portuguese_Brazil.utf8   \n#> [3] LC_MONETARY=Portuguese_Brazil.utf8 LC_NUMERIC=C                      \n#> [5] LC_TIME=Portuguese_Brazil.utf8    \n#> \n#> time zone: America/Sao_Paulo\n#> tzcode source: internal\n#> \n#> attached base packages:\n#> [1] stats     graphics  grDevices utils     datasets  methods   base     \n#> \n#> other attached packages:\n#>  [1] MASS_7.3-65     ISLR_1.4        pROC_1.19.0.1   patchwork_1.3.1\n#>  [5] caret_7.0-1     lattice_0.22-7  lubridate_1.9.4 forcats_1.0.0  \n#>  [9] stringr_1.5.1   dplyr_1.1.4     purrr_1.1.0     readr_2.1.5    \n#> [13] tidyr_1.3.1     tibble_3.3.0    ggplot2_3.5.2   tidyverse_2.0.0\n#> \n#> loaded via a namespace (and not attached):\n#>  [1] gtable_0.3.6         xfun_0.52            htmlwidgets_1.6.4   \n#>  [4] recipes_1.3.1        tzdb_0.5.0           vctrs_0.6.5         \n#>  [7] tools_4.5.1          generics_0.1.4       stats4_4.5.1        \n#> [10] parallel_4.5.1       proxy_0.4-27         ModelMetrics_1.2.2.2\n#> [13] pkgconfig_2.0.3      Matrix_1.7-3         data.table_1.17.8   \n#> [16] RColorBrewer_1.1-3   lifecycle_1.0.4      compiler_4.5.1      \n#> [19] farver_2.1.2         codetools_0.2-20     htmltools_0.5.8.1   \n#> [22] class_7.3-23         yaml_2.3.10          prodlim_2025.04.28  \n#> [25] pillar_1.11.0        gower_1.0.2          iterators_1.0.14    \n#> [28] rpart_4.1.24         foreach_1.5.2        nlme_3.1-168        \n#> [31] parallelly_1.45.1    lava_1.8.1           tidyselect_1.2.1    \n#> [34] digest_0.6.37        stringi_1.8.7        future_1.67.0       \n#> [37] reshape2_1.4.4       listenv_0.9.1        labeling_0.4.3      \n#> [40] splines_4.5.1        fastmap_1.2.0        grid_4.5.1          \n#> [43] cli_3.6.5            magrittr_2.0.3       dichromat_2.0-0.1   \n#> [46] survival_3.8-3       e1071_1.7-16         future.apply_1.20.0 \n#> [49] withr_3.0.2          scales_1.4.0         timechange_0.3.0    \n#> [52] rmarkdown_2.29       globals_0.18.0       nnet_7.3-20         \n#> [55] timeDate_4041.110    hms_1.1.3            evaluate_1.0.4      \n#> [58] knitr_1.50           hardhat_1.4.1        rlang_1.1.6         \n#> [61] Rcpp_1.1.0           glue_1.8.0           ipred_0.9-15        \n#> [64] rstudioapi_0.17.1    jsonlite_2.0.0       R6_2.6.1            \n#> [67] plyr_1.8.9\n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "Aula09_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}